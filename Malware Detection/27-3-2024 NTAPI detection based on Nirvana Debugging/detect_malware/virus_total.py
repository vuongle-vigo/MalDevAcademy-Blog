import json

import requests
import logging
from utils import *

api_keys = ['047275ebbcfea616e5c80e2d8f3eec6b1dd0832da07dafb8cdcea4ec7df2a5d2']


class VirusTotal:
    def __init__(self, api_keys):
        self.api_keys = api_keys
        self.queries = load_config()['virus_total']

    def send_request(self, url, header):
        try:
            response = requests.post(url, headers=header)
            response.raise_for_status()  # check error http
            return response
        except requests.exceptions.RequestException as e:
            logging.error(f"Error sending request: {e}")
            return None

    def send_query(self, query_type, **kwargs):
        params = self.queries[query_type]['params']
        if not check_params(params, **kwargs):
            return None
        url = self.queries[query_type]['url']

        for api_key in self.api_keys:
            headers = {
                "Accept": "application/json",
                "x-apikey": api_key
            }
            try:
                response = requests.get(url, headers=headers)
                response.raise_for_status()  # Raise exception for non-2xx status codes
                return response.json()
            except requests.exceptions.RequestException as e:
                logging.error(f"Error: {e}")
                return None

    def get_file_report(self, file_id):
        url = f"https://www.virustotal.com/api/v3/files/{file_id}"
        for api_key in self.api_keys:
            headers = {
                "Accept": "application/json",
                "x-apikey": api_key
            }

            try:
                response = requests.get(url, headers=headers)
                response.raise_for_status()  # Raise exception for non-2xx status codes
                return response.json()
            except requests.exceptions.RequestException as e:
                logging.error(f"Error: {e}")
                return None

    def get_recent_files(self):
        url = "https://www.virustotal.com/api/v3/intelligence/hunting_notifications"
        for api_key in self.api_keys:
            headers = {
                "Accept": "application/json",
                "x-apikey": api_key
            }

            try:
                response = requests.get(url, headers=headers)
                response.raise_for_status()
                data = response.json()
                return data["data"]
            except requests.exceptions.RequestException as e:
                print(f"Error: {e}")
                return []


file_id = '217f7bd83a9dedc089d5001b90cd3e4339b5dd1bc6252b1e2cabcd6af0b44c35'

vt = VirusTotal(api_keys)
file_report = vt.get_file_report(file_id)
print(file_report)

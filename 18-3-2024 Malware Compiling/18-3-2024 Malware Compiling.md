## Malware Compiling

Mã sử dụng:
```c
#include <Windows.h>

int main() {
	MessageBoxA(NULL, "Hi", "Hi", MB_OK);
	return 1;
}
```

### Build với VS2022

***Release MD***
![debug](images/debug.png)

***Release MT***
![releasemt](images/releasemt.png)

***Disable Debug information + C++ Exception + Optimization + Manifest***

Không ảnh hưởng đến IAT, chỉ loại bỏ thông tin và tối ưu mã.

Tắt `Generate Debug Info`:

![debuginfo](images/debuginfo.png)

Tắt `Enable C++ Exception`:

![exception](images/exception.png)

Tắt `Whole Program Optimization`:

![optimization](images/optimization.png)

Tắt `Generate Manifest`:

![manifest](images/manifest.png)

***Nodefaultlibs***

Bật tùy chọn này gây ra lỗi sau:

![errornodefaultlibs](images/errornodefaultlibs.png)

Thay đổi entryPoint thành main, sẽ fix được lỗi trên.

![entry](images/entry.png)

Kết quả kích thước file giảm từ 113kb xuống 3kb:

Ban đầu khi build release MT + no debug:

![result2](images/result2.png)

Sau đó khi đã tối ưu mọi thứ:

![result1](images/result1.png)

### Build mã với gcc/g++

Việc sử dụng gcc/g++ gặp nhiều vấn đề hơn tuy nhiên hiệu quả ngang bằng hoặc hơn khi build bằng vs2022, tuy nhiên kích thước file sau khi build xong lại có phần lớn hơn. Link tải gcc/g++: https://winlibs.com/

```cmd
g++ -fno-exceptions -O0 main.cpp -o main -nostdlib -luser32 -lgcc -lmsvcr120 -mwindows
```

- `-fno-exceptions`: Tắt exception giống như vs2022 ở trên
- `-O0`: tắt tối ưu hóa code
- `-nostdlib`: kiểm soát hoàn toàn quá trình liên kết, loại bỏ các file startup, sử dụng tham số này sẽ loại bỏ `CRT`, tuy nhiên cần liên kết những lib sẽ cần sử dụng, đồng thời chương trình sẽ không nhận điểm đầu vào là main
- `-luser32`: Liên kết thư viện windows nếu sử dụng dll trong chương trình
- `-lgcc`: Giúp chương trình nhận entry là `main`
- `-lmsvcr120`: Khác phục lỗi `atexit()` không được tìm thấy
- `-mwindows`: Ẩn console khi chương trình chạy

Ngoài ra, còn 1 số tham số quan trọng cần lưu ý nếu cần sử dụng:

- `-lmsvcrt`: liên kết thư viện crt
- `-s`: Tối ưu hóa mã ngắn hơn, giảm số lượng section (Giảm từ 19kb xuống 5kb tuy nhiên +1 virustotal)
- `-flto`: Tối ưu mã (giảm dung lượng và mã vẫn chạy tốt: từ 19kb xuống còn 15kb).

***Lưu ý***

Có vẻ việc sử dụng `-lmsvcr120` có thể fix được lỗi tuy nhiên vì lý do bản quyền, gcc mingw không được phép link tĩnh các, điều này khiến cho file chạy trên các máy chưa có `mscvr120.dll` sẽ gây lỗi, hiện tại chưa tìm được cách fix lỗi này (hoặc lỗi atexit()).

***Kết quả virustotal***

![result3](images/result3.png)